<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feed Scraper</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --success: #16a34a;
            --error: #dc2626;
            --warning: #d97706;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --border: #e5e7eb;
            --bg: #f9fafb;
            --surface: #ffffff;
            --shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: var(--bg); color: var(--gray-800); line-height: 1.5; font-size: 14px; }
        
        .container { max-width: 1100px; margin: 0 auto; padding: 24px; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--border); }
        .header h1 { font-size: 20px; font-weight: 600; color: var(--gray-900); }
        
        .lang-switcher { display: flex; gap: 4px; }
        .lang-btn { padding: 4px 10px; border: 1px solid var(--border); background: var(--surface); cursor: pointer; font-size: 12px; font-weight: 500; color: var(--gray-600); border-radius: 4px; }
        .lang-btn:hover { background: var(--gray-100); }
        .lang-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: var(--surface); padding: 16px; border-radius: 8px; box-shadow: var(--shadow); border: 1px solid var(--border); }
        .stat-card .number { font-size: 28px; font-weight: 600; color: var(--gray-900); }
        .stat-card .label { color: var(--gray-500); font-size: 13px; margin-top: 2px; }
        .stat-card.success .number { color: var(--success); }
        .stat-card.error .number { color: var(--error); }
        
        .actions { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
        button, .btn { padding: 8px 14px; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.15s; text-decoration: none; display: inline-flex; align-items: center; gap: 6px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-secondary { background: var(--gray-100); color: var(--gray-700); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--gray-200); }
        .btn-danger { background: white; color: var(--error); border: 1px solid var(--error); }
        .btn-danger:hover { background: var(--error); color: white; }
        .btn-success { background: white; color: var(--success); border: 1px solid var(--success); }
        .btn-success:hover { background: var(--success); color: white; }
        .btn-warning { background: white; color: var(--warning); border: 1px solid var(--warning); }
        .btn-warning:hover { background: var(--warning); color: white; }
        .btn-info { background: white; color: #3b82f6; border: 1px solid #3b82f6; }
        .btn-info:hover { background: #3b82f6; color: white; }
        
        .tabs { display: flex; gap: 0; margin-bottom: 20px; border-bottom: 1px solid var(--border); }
        .tab { padding: 10px 18px; cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -1px; color: var(--gray-500); font-weight: 500; }
        .tab:hover { color: var(--gray-700); }
        .tab.active { border-bottom-color: var(--primary); color: var(--primary); }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .card { background: var(--surface); border-radius: 8px; box-shadow: var(--shadow); border: 1px solid var(--border); overflow: hidden; }
        .card-header { padding: 14px 18px; border-bottom: 1px solid var(--border); font-weight: 600; background: var(--gray-50); }
        
        .feed-item { display: flex; align-items: center; padding: 14px 18px; border-bottom: 1px solid var(--border); }
        .feed-item .feed-checkbox { margin-right: 12px; width: 18px; height: 18px; cursor: pointer; }
        .feed-item:last-child { border-bottom: none; }
        .feed-info { flex: 1; min-width: 0; }
        .feed-name { font-weight: 600; color: var(--gray-900); font-size: 14px; }
        .feed-url { font-size: 12px; color: var(--gray-400); margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .feed-error { font-size: 12px; color: var(--error); margin-top: 4px; font-weight: 500; }
        .feed-meta { font-size: 12px; color: var(--gray-500); margin-top: 4px; display: flex; gap: 12px; }
        .feed-meta span { display: flex; align-items: center; gap: 4px; }
        
        .status-dot { width: 8px; height: 8px; border-radius: 50%; margin-right: 12px; flex-shrink: 0; }
        .status-dot.success { background: var(--success); }
        .status-dot.error { background: var(--error); }
        .status-dot.pending { background: var(--warning); }
        
        .feed-actions { display: flex; gap: 6px; flex-shrink: 0; }
        .feed-actions button, .feed-actions a { padding: 5px 10px; font-size: 12px; }
        
        .empty { text-align: center; padding: 48px 24px; color: var(--gray-400); font-size: 14px; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 1000; }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: var(--surface); padding: 24px; border-radius: 10px; width: 520px; max-width: 95%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 40px rgba(0,0,0,0.15); }
        .modal h2 { font-size: 18px; font-weight: 600; margin-bottom: 18px; color: var(--gray-900); }
        
        .form-group { margin-bottom: 14px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; color: var(--gray-700); font-size: 13px; }
        .form-group input, .form-group textarea { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; background: var(--surface); color: var(--gray-900); }
        .form-group input:focus, .form-group textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
        .form-group textarea { height: 80px; resize: vertical; }
        .form-row { display: flex; gap: 12px; }
        .form-row .form-group { flex: 1; }
        
        .modal-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border); }
        
        .toast { position: fixed; bottom: 24px; right: 24px; background: var(--gray-800); color: white; padding: 12px 18px; border-radius: 6px; opacity: 0; transition: opacity 0.3s; z-index: 2000; font-size: 13px; }
        .toast.show { opacity: 1; }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--error); }
        
        .discovered-feeds { margin-top: 16px; max-height: 240px; overflow-y: auto; }
        .discovered-feed { padding: 12px; border: 1px solid var(--border); border-radius: 6px; margin-bottom: 8px; cursor: pointer; transition: all 0.15s; }
        .discovered-feed:hover { border-color: var(--primary); background: #f0f7ff; }
        .discovered-feed input { margin-right: 10px; }
        
        @media (max-width: 640px) {
            .form-row { flex-direction: column; gap: 8px; }
            .stats { grid-template-columns: 1fr; }
            .feed-item { flex-direction: column; align-items: flex-start; gap: 10px; }
            .status-dot { margin: 0 0 8px 0; }
            .feed-actions { width: 100%; justify-content: flex-end; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Feed Scraper</h1>
            <div class="lang-switcher">
                <button class="lang-btn" data-lang="de" onclick="setLanguage('de')">DE</button>
                <button class="lang-btn" data-lang="en" onclick="setLanguage('en')">EN</button>
                <button class="lang-btn" data-lang="tr" onclick="setLanguage('tr')">TR</button>
            </div>
        </div>
        
        <div class="tabs">
            <div class="tab active" data-tab="feeds" data-i18n="feeds">Feeds</div>
            <div class="tab" data-tab="import" data-i18n="import">Import</div>
            <div class="tab" data-tab="tools" data-i18n="tools">Tools</div>
        </div>
        
        <!-- Tab: Feeds -->
        <div class="tab-content active" id="tab-feeds">
            <div class="stats">
                <div class="stat-card">
                    <div class="number" id="total">{{ feeds|length }}</div>
                    <div class="label" data-i18n="total">Feeds</div>
                </div>
                <div class="stat-card success">
                    <div class="number">{{ feeds|selectattr('last_status', 'equalto', 'success')|list|length }}</div>
                    <div class="label" data-i18n="success">Success</div>
                </div>
                <div class="stat-card error">
                    <div class="number">{{ feeds|selectattr('last_status', 'equalto', 'error')|list|length }}</div>
                    <div class="label" data-i18n="error">Error</div>
                </div>
            </div>
            
            <div class="actions">
                <button class="btn btn-primary" onclick="showModal('feedModal')" data-i18n="newFeed">+ New Feed</button>
                <button class="btn btn-secondary" onclick="refreshAll()" data-i18n="refreshAll">Refresh All</button>
                <button class="btn btn-secondary" onclick="showModal('discoverModal')" data-i18n="discover">Discover</button>
            </div>
            
            <div class="card">
                <div class="bulk-actions" id="bulkActions" style="display:none; margin-bottom: 12px; padding: 8px 12px; background: var(--bg-secondary); border-radius: 6px;">
                    <label style="margin-right: 16px;"><input type="checkbox" id="selectAll" onchange="toggleAll(this)"> <span data-i18n="selectAll">Alle auswählen</span></label>
                    <button class="btn btn-warning" onclick="bulkRefresh()" data-i18n="refreshSelected">Ausgewählte aktualisieren</button>
                    <button class="btn btn-danger" onclick="bulkDelete()" data-i18n="deleteSelected">Ausgewählte löschen</button>
                </div>
                {% if feeds %}
                    {% for feed in feeds %}
                    <div class="feed-item">
                        <input type="checkbox" class="feed-checkbox" value="{{ feed.name }}" onchange="updateBulkActions()">
                        <div class="status-dot {{ feed.last_status or 'pending' }}"></div>
                        <div class="feed-info">
                            <div class="feed-name">{{ feed.name }}</div>
                            <div class="feed-url">{{ feed.url }}</div>
                            {% if feed.last_status == 'error' and feed.last_error %}
                            <div class="feed-error">{{ feed.last_error }}</div>
                            {% endif %}
                            <div class="feed-meta">
                                <span>{{ feed.css_selector or 'auto' }}</span>
                                <span>{% if feed.last_update %}{{ feed.last_update[:16] }}{% else %}<span data-i18n="never">Never</span>{% endif %}</span>
                                <span>{{ feed.article_count or 0 }} <span data-i18n="articles">Articles</span></span>
                            </div>
                        </div>
                        <div class="feed-actions">
                            <a href="/feed/{{ feed.name }}.xml" target="_blank" class="btn btn-secondary">XML</a>
                            <button class="btn btn-secondary" onclick="previewFeed('{{ feed.name }}', '{{ feed.url }}', '{{ feed.css_selector }}')">Preview</button>
                            <button class="btn btn-info" onclick="editFeed('{{ feed.name }}')">Edit</button>
                            <button class="btn btn-warning" onclick="refreshFeed('{{ feed.name }}')">Refresh</button>
                            <button class="btn btn-danger" onclick="deleteFeed('{{ feed.name }}')">Delete</button>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty" data-i18n="noFeeds">No feeds yet. Create a new feed.</div>
                {% endif %}
            </div>
        </div>
        
        <!-- Tab: Import -->
        <div class="tab-content" id="tab-import">
            <div class="actions">
                <button class="btn btn-primary" onclick="showModal('feedModal')" data-i18n="newFeed">+ New Feed</button>
                <button class="btn btn-primary" onclick="showModal('bulkModal')" data-i18n="bulkImport">+ Bulk Import</button>
                <button class="btn btn-secondary" onclick="showModal('opmlImportModal')" data-i18n="opmlImport">Import OPML</button>
            </div>
            
            <div class="card" style="margin-top: 20px;">
                <div class="empty" data-i18n="importDescription">
                    Import feeds from OPML files or add multiple URLs at once.
                </div>
            </div>
        </div>
        
        <!-- Tab: Tools -->
        <div class="tab-content" id="tab-tools">
            <div class="actions">
                <a href="/export/opml" class="btn btn-primary" data-i18n="opmlExport">Export OPML</a>
                <a href="/api/backup" class="btn btn-secondary" data-i18n="backup">Create Backup</a>
                <button class="btn btn-warning" onclick="showModal('restoreModal')" data-i18n="restore">Restore</button>
            </div>
            
            <div class="card" style="margin-top: 20px;">
                <div class="empty" data-i18n="toolsDescription">
                    Tools for import, export and backup.
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal: New Feed -->
    <div class="modal" id="feedModal">
        <div class="modal-content">
            <h2 id="feedModalTitle" data-i18n="newFeed">New Feed</h2>
            <form id="feedForm">
                <input type="hidden" id="editMode" value="">
                <div class="form-row">
                    <div class="form-group">
                        <label data-i18n="name">Name</label>
                        <input type="text" name="name" required>
                    </div>
                    <div class="form-group">
                        <label data-i18n="url">URL</label>
                        <input type="url" name="url" required>
                    </div>
                </div>
                <div class="form-group">
                    <label data-i18n="cssSelector">CSS Selector (optional)</label>
                    <input type="text" name="css_selector">
                </div>
                <div class="form-group">
                    <label data-i18n="category">Category</label>
                    <input type="text" name="description">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="hideModal('feedModal')" data-i18n="cancel">Cancel</button>
                    <button type="button" class="btn btn-secondary" onclick="discoverFromForm()">Discover</button>
                    <button type="submit" class="btn btn-primary" data-i18n="create">Create</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal: Bulk Import -->
    <div class="modal" id="bulkModal">
        <div class="modal-content">
            <h2 data-i18n="bulkImport">Bulk Import</h2>
            <form id="bulkForm">
                <div class="form-group">
                    <label data-i18n="bulkUrls">URLs (one per line)</label>
                    <textarea name="urls" style="height: 160px;"></textarea>
                </div>
                <div class="form-group">
                    <label data-i18n="cssSelector">CSS Selector (optional)</label>
                    <input type="text" name="css_selector">
                </div>
                <div class="form-group">
                    <label data-i18n="category">Category</label>
                    <input type="text" name="description">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="hideModal('bulkModal')" data-i18n="cancel">Cancel</button>
                    <button type="submit" class="btn btn-primary" data-i18n="importAll">Import All</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal: Discover -->
    <div class="modal" id="discoverModal">
        <div class="modal-content">
            <h2 data-i18n="discoverTitle">Discover Feed</h2>
            <div class="form-group">
                <label data-i18n="url">Website URL</label>
                <input type="url" id="discoverUrl">
            </div>
            <button class="btn btn-primary" onclick="runDiscover()" style="width:100%;">Search</button>
            <div id="discoverResults" class="discovered-feeds"></div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="hideModal('discoverModal')" data-i18n="close">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Modal: OPML Import -->
    <div class="modal" id="opmlImportModal">
        <div class="modal-content">
            <h2 data-i18n="opmlImport">Import OPML</h2>
            <form id="opmlForm" enctype="multipart/form-data">
                <div class="form-group">
                    <label data-i18n="opmlFile">OPML File</label>
                    <input type="file" name="opml_file" accept=".opml,.xml" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="hideModal('opmlImportModal')" data-i18n="cancel">Cancel</button>
                    <button type="submit" class="btn btn-primary" data-i18n="importAll">Import</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal: Restore -->
    <div class="modal" id="restoreModal">
        <div class="modal-content">
            <h2 data-i18n="restore">Restore Backup</h2>
            <form id="restoreForm" enctype="multipart/form-data">
                <div class="form-group">
                    <label data-i18n="backupFile">Backup File (JSON)</label>
                    <input type="file" name="backup_file" accept=".json" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="hideModal('restoreModal')" data-i18n="cancel">Cancel</button>
                    <button type="submit" class="btn btn-warning" data-i18n="restoreConfirm">Restore</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal: Preview -->
    <div class="modal" id="previewModal">
        <div class="modal-content">
            <h2 data-i18n="preview">Preview</h2>
            <div id="previewContent"></div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="hideModal('previewModal')" data-i18n="close">Close</button>
            </div>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>
    
    <script>
        // Translations
        let translations = {};
        let currentLang = localStorage.getItem('feedScraperLang') || 'de';
        
        async function loadTranslations() {
            const response = await fetch('/templates/translations.json');
            translations = await response.json();
            applyTranslations();
            updateLangButtons();
        }
        
        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('feedScraperLang', lang);
            applyTranslations();
            updateLangButtons();
        }
        
        function updateLangButtons() {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.lang === currentLang);
            });
            document.documentElement.lang = currentLang;
        }
        
        function applyTranslations() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.dataset.i18n;
                if (translations[currentLang] && translations[currentLang][key]) {
                    el.textContent = translations[currentLang][key];
                }
            });
        }
        
        loadTranslations();
        
        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
            });
        });
        
        function showModal(id) { document.getElementById(id).classList.add('active'); }
        function hideModal(id) { 
            document.getElementById(id).classList.remove('active'); 
            if (id === 'feedModal') {
                const form = document.getElementById('feedForm');
                form.reset();
                document.getElementById('editMode').value = '';
                document.getElementById('feedModalTitle').textContent = translations[currentLang].newFeed || 'New Feed';
                document.querySelector('#feedModal button[type="submit"]').textContent = translations[currentLang].create || 'Create';
            }
        }
        
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show ' + type;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        // Single Feed
        document.getElementById('feedForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const data = {
                name: form.name.value,
                url: form.url.value,
                css_selector: form.css_selector.value,
                description: form.description.value
            };
            
            const editMode = document.getElementById('editMode').value;
            let url = '/api/feeds';
            let method = 'POST';
            
            if (editMode) {
                url = `/api/feeds/${editMode}`;
                method = 'PUT';
            }
            
            const res = await fetch(url, {
                method: method,
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            if (res.ok) {
                hideModal('feedModal');
                form.reset();
                document.getElementById('editMode').value = '';
                document.getElementById('feedModalTitle').textContent = translations[currentLang].newFeed || 'New Feed';
                document.querySelector('#feedModal button[type="submit"]').textContent = translations[currentLang].create || 'Create';
                showToast(translations[currentLang].feedCreated || 'Feed created!');
                location.reload();
            } else {
                const err = await res.json();
                showToast('Error: ' + err.detail, 'error');
            }
        });
        
        // Bulk Import
        document.getElementById('bulkForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const urls = form.urls.value.split('\n').filter(u => u.trim());
            
            const feeds = urls.map(url => ({
                name: url.replace(/[^a-z0-9]/gi, '-').substring(0, 50),
                url: url.trim(),
                css_selector: form.css_selector.value,
                description: form.description.value
            }));
            
            const res = await fetch('/api/feeds/bulk', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({feeds})
            });
            
            const result = await res.json();
            hideModal('bulkModal');
            form.reset();
            let msg = `${result.created} feeds created, ${result.errors} errors`;
            if (result.skipped > 0) {
                msg += `, ${result.skipped} skipped`;
            }
            showToast(msg);
            setTimeout(() => location.reload(), 1500);
        });
        
        // Preview
        async function previewFeed(name, url, selector) {
            const res = await fetch('/api/preview', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({name, url, css_selector: selector})
            });
            const data = await res.json();
            
            const content = document.getElementById('previewContent');
            if (data.status === 'success') {
                let html = `<p style="margin-bottom:12px;">${data.article_count} articles found:</p>`;
                data.articles.slice(0, 10).forEach(art => {
                    html += `<div style="padding:8px 0;border-bottom:1px solid var(--border);"><a href="${art.url}" target="_blank" style="color:var(--primary);text-decoration:none;font-weight:500;">${art.title}</a><br><small style="color:var(--gray-400);">${art.date_published || ''}</small></div>`;
                });
                content.innerHTML = html;
            } else {
                content.innerHTML = `<p style="color:var(--error);">Error: ${data.error}</p>`;
            }
            showModal('previewModal');
        }
        
        // Discover
        async function runDiscover() {
            let url = document.getElementById('discoverUrl').value.trim();
            if (!url) return;
            
            // Add https:// if no scheme
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                url = 'https://' + url;
            }
            
            const res = await fetch(`/api/discover?url=${encodeURIComponent(url)}`);
            const data = await res.json();
            
            const results = document.getElementById('discoverResults');
            if (data.feeds && data.feeds.length > 0) {
                let html = '';
                data.feeds.forEach(feed => {
                    const isScrape = feed.type === 'scrape';
                    const label = isScrape ? 'Webseite scrapper' : 'RSS Feed';
                    const domain = new URL(url).hostname;
                    const defaultName = domain.replace(/^www\./, '').split('.')[0];
                    html += `<div class="discovered-feed">
                        <input type="checkbox" data-url="${feed.url}" data-title="${feed.title}" data-type="${feed.type}" data-name="${defaultName}">
                        <strong>${feed.title}</strong>
                        <span style="color:var(--gray-400);font-size:11px;"> - ${label}</span><br>
                        <small style="color:var(--gray-400);">${feed.url}</small>
                        <button class="btn btn-primary" style="margin-top:8px;width:100%;" onclick="addSingleFeed('${feed.url}', '${defaultName}', '${feed.type}')">Übernehmen</button>
                    </div>`;
                });
                results.innerHTML = html;
            } else {
                // Fallback: Original-URL as Scrape option
                const domain = new URL(url).hostname;
                const defaultName = domain.replace(/^www\./, '').split('.')[0];
                results.innerHTML = `<div class="discovered-feed">
                    <input type="checkbox" data-url="${url}" data-title="Webseite" data-type="scrape" data-name="${defaultName}">
                    <strong>${domain}</strong><br>
                    <small style="color:var(--gray-400);">${url}</small>
                    <button class="btn btn-primary" style="margin-top:8px;width:100%;" onclick="addSingleFeed('${url}', '${defaultName}', 'scrape')">Übernehmen</button>
                </div>`;
            }
        }
        
        function addSingleFeed(url, title, type) {
            // Generate name from domain if not provided
            let name = title;
            if (!name || name === 'Webseite (Scrapen)') {
                try {
                    const domain = new URL(url).hostname;
                    name = domain.replace(/^www\./, '').split('.')[0];
                } catch (e) {
                    name = 'feed-' + Date.now();
                }
            }
            
            fetch('/api/feeds', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    name: name,
                    url: url,
                    css_selector: '',
                    description: type === 'scrape' ? 'Gescraped' : 'RSS Feed'
                })
            }).then(res => {
                if (res.ok) {
                    showToast('Feed übernommen!');
                    hideModal('discoverModal');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    res.json().then(err => showToast('Error: ' + err.detail, 'error'));
                }
            });
        }
        
        function addDiscoveredFeeds() {
            // Removed - now using individual buttons instead
        }
        
        function discoverFromForm() {
            const form = document.getElementById('feedForm');
            const url = form.url.value;
            if (url) {
                document.getElementById('discoverUrl').value = url;
                showModal('discoverModal');
                runDiscover();
            }
        }
        
        // OPML Import
        document.getElementById('opmlForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(document.getElementById('opmlForm'));
            
            const res = await fetch('/import/opml', {
                method: 'POST',
                body: formData
            });
            
            const result = await res.json();
            hideModal('opmlImportModal');
            let msg = `${result.imported} feeds imported`;
            if (result.skipped > 0) {
                msg += `, ${result.skipped} skipped`;
            }
            if (result.errors > 0) {
                msg += `, ${result.errors} errors`;
            }
            showToast(msg);
            setTimeout(() => location.reload(), 1500);
        });
        
        // Restore
        document.getElementById('restoreForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(document.getElementById('restoreForm'));
            
            const res = await fetch('/api/restore', {
                method: 'POST',
                body: formData
            });
            
            const result = await res.json();
            hideModal('restoreModal');
            showToast(`${result.restored} feeds restored`);
            setTimeout(() => location.reload(), 1500);
        });
        
        // Feed Actions
        async function refreshFeed(name) {
            await fetch(`/api/feeds/${name}/refresh`, {method: 'POST'});
            location.reload();
        }
        
        async function refreshAll() {
            showToast(translations[currentLang].refreshing || 'Refreshing...');
            await fetch('/api/refresh-all', {method: 'POST'});
            location.reload();
        }
        
        function toggleAll(masterCheckbox) {
            const checkboxes = document.querySelectorAll('.feed-checkbox');
            checkboxes.forEach(cb => cb.checked = masterCheckbox.checked);
            updateBulkActions();
        }
        
        function updateBulkActions() {
            const checkboxes = document.querySelectorAll('.feed-checkbox:checked');
            const bulkActions = document.getElementById('bulkActions');
            if (checkboxes.length > 0) {
                bulkActions.style.display = 'flex';
            } else {
                bulkActions.style.display = 'none';
            }
        }
        
        async function bulkRefresh() {
            const checkboxes = document.querySelectorAll('.feed-checkbox:checked');
            const names = Array.from(checkboxes).map(cb => cb.value);
            if (names.length === 0) return;
            
            showToast(translations[currentLang].refreshing || 'Refreshing...');
            const res = await fetch('/api/feeds/bulk/refresh', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(names)
            });
            const data = await res.json();
            const success = data.results.filter(r => r.status === 'success').length;
            const error = data.results.filter(r => r.status === 'error').length;
            showToast(`${success} refreshed, ${error} errors`);
            location.reload();
        }
        
        async function bulkDelete() {
            const checkboxes = document.querySelectorAll('.feed-checkbox:checked');
            const names = Array.from(checkboxes).map(cb => cb.value);
            if (names.length === 0) return;
            
            const msg = (translations[currentLang].confirmBulkDelete || 'Delete X feeds?').replace('X', names.length);
            if (confirm(msg)) {
                const res = await fetch('/api/feeds/bulk/delete', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(names)
                });
                const data = await res.json();
                showToast(`${data.deleted.length} deleted`);
                location.reload();
            }
        }
        
        async function editFeed(name) {
            const res = await fetch('/api/feeds');
            const feeds = await res.json();
            const feed = feeds.find(f => f.name === name);
            if (!feed) return;
            
            const form = document.getElementById('feedForm');
            form.name.value = feed.name;
            form.url.value = feed.url;
            form.css_selector.value = feed.css_selector || '';
            form.description.value = feed.description || '';
            
            document.getElementById('feedModalTitle').textContent = translations[currentLang].edit || 'Edit';
            document.querySelector('#feedModal button[type="submit"]').textContent = translations[currentLang].save || 'Save';
            document.getElementById('editMode').value = name;
            
            showModal('feedModal');
        }
        
        async function deleteFeed(name) {
            if (confirm(`Delete feed "${name}"?`)) {
                await fetch(`/api/feeds/${name}`, {method: 'DELETE'});
                location.reload();
            }
        }
    </script>
</body>
</html>
